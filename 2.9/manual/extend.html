<html><head><title>Writing an extension for Ocsigen server</title><meta charset="utf8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link rel="stylesheet" href="https://ocsigen.org/css/style.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/themes/prism.min.css"/><script type="application/javascript" src="https://ocsigen.org/js/client.js">
//<![CDATA[

//]]>
</script><script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-core.min.js">
//<![CDATA[

//]]>
</script><script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-ocaml.min.js">
//<![CDATA[

//]]>
</script><script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-clike.min.js">
//<![CDATA[

//]]>
</script><script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-reason.min.js">
//<![CDATA[

//]]>
</script><script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-javascript.min.js">
//<![CDATA[

//]]>
</script></head><body class="extend ocsigenserver"><div class="project-page"><div class="page-header"><p class="logo-ocsigen"><a href=".././../../" class="ocsimore_phrasing_link"><img src=".././../../img/ocsigen-white.svg" alt="Ocsigen"/></a>
</p><p class="logo-subproject">Server</p><div class="mainmenu"><p class="mainmenu-home"><a href=".././../../" class="ocsimore_phrasing_link">Home</a></p><p class="mainmenu-doc"><a href=".././../../tuto/" class="ocsimore_phrasing_link">Doc</a></p><p><a href=".././../../eliom/" class="ocsimore_phrasing_link">Eliom</a></p><p><a href=".././../../js_of_ocaml/" class="ocsimore_phrasing_link">Js_of_ocaml</a></p><p><a href=".././../../lwt/" class="ocsimore_phrasing_link">Lwt</a></p><p><a href=".././../../tyxml/" class="ocsimore_phrasing_link">Tyxml</a></p><p><a href=".././../../ocsigen-start/" class="ocsimore_phrasing_link">Start</a></p></div><form id="googlesearch" action="https://google.com/search"><input name="q" id="gsearch-box" placeholder="Search using Google"/><label for="gsearch-box"><img src="/img/search.svg" alt="" id="gsearch-icon"/></label><input type="submit" id="gsearch-submit" onclick="document.getElementById('gsearch-box').value += ' site:ocsigen.org';"/></form><aside class="how-drawer"><input id="how-drawer-toggle" type="checkbox"/><label for="how-drawer-toggle" id="how-drawer-label"><span class="how-drawer-icon"></span></label><nav class="how-drawer-content"><ul class="drawermainmenu"><li class="drawermainmenu-home"><a href=".././../../" class="ocsimore_phrasing_link">Home</a>
</li><li class="drawermainmenu-doc"><a href=".././../../tuto/" class="ocsimore_phrasing_link">Doc</a>
</li><li class="drawermainmenu-project"><a href=".././../../eliom/" class="ocsimore_phrasing_link">Eliom</a>
</li><li class="drawermainmenu-project"><a href=".././../../js_of_ocaml/" class="ocsimore_phrasing_link">Js_of_ocaml</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigenserver/" class="ocsimore_phrasing_link">Server</a>
</li><li class="drawermainmenu-project"><a href=".././../../lwt/" class="ocsimore_phrasing_link">Lwt</a>
</li><li class="drawermainmenu-project"><a href=".././../../tyxml/" class="ocsimore_phrasing_link">Tyxml</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigen-toolkit/" class="ocsimore_phrasing_link">Toolkit</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigen-start/" class="ocsimore_phrasing_link">Start</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsipersist/" class="ocsimore_phrasing_link">Ocsipersist</a>
</li><li class="drawermainmenu-project"><a href=".././../../html_of_wiki/" class="ocsimore_phrasing_link">html_of_wiki</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsimore/" class="ocsimore_phrasing_link">Ocsimore (<em>deprecated</em>)</a>
</li><li class="drawermainmenu-page"><a href=".././../../projects" class="ocsimore_phrasing_link">Other projects</a>
</li><li class="drawermainmenu-page"><a href=".././../../papers" class="ocsimore_phrasing_link">Research papers</a>
</li><li class="drawermainmenu-page"><a href=".././../../credits" class="ocsimore_phrasing_link">Who does Ocsigen?</a>
</li><li class="drawermainmenu-page"><a href=".././../../contributing" class="ocsimore_phrasing_link">Contributing</a>
</li><li class="drawermainmenu-page"><a href=".././../../blog" class="ocsimore_phrasing_link">Blog</a>
</li><li class="drawermainmenu-page"><a href=".././../../install" class="ocsimore_phrasing_link">Installation</a>
</li><li class="drawermainmenu-page"><a href="https://github.com/ocsigen" class="ocsimore_phrasing_link">Source code</a>
</li></ul><nav class="how-doctree"><h1>Ocsigen server</h1><h2>Usage</h2><h3><a href="quickstart" class="ocsimore_phrasing_link">Quick start</a></h3><h3><a href="launching" class="ocsimore_phrasing_link">Launching the server</a></h3><h3><a href="config" class="ocsimore_phrasing_link">Configuration file</a></h3><h3><a href="misc" class="ocsimore_phrasing_link">Misc</a></h3><h2>Extensions</h2><h3><a href="staticmod" class="ocsimore_phrasing_link">Staticmod</a></h3><h3><a href="eliom" class="ocsimore_phrasing_link">Eliom</a></h3><h3><a href="extendconfiguration" class="ocsimore_phrasing_link">Extendconfiguration</a></h3><h3><a href="accesscontrol" class="ocsimore_phrasing_link">Accesscontrol</a></h3><h3><a href="authbasic" class="ocsimore_phrasing_link">Authbasic</a></h3><h3><a href="cgimod" class="ocsimore_phrasing_link">CGImod</a></h3><h3><a href="deflatemod" class="ocsimore_phrasing_link">Deflatemod</a></h3><h3><a href="redirectmod" class="ocsimore_phrasing_link">Redirectmod</a></h3><h3><a href="revproxy" class="ocsimore_phrasing_link">Revproxy</a></h3><h3><a href="rewritemod" class="ocsimore_phrasing_link">Rewritemod</a></h3><h3><a href="outputfilter" class="ocsimore_phrasing_link">Outputfilter</a></h3><h3><a href="userconf" class="ocsimore_phrasing_link">Userconf</a></h3><h3><a href="comet" class="ocsimore_phrasing_link">Comet</a></h3><h3><a href="cors" class="ocsimore_phrasing_link">CORS</a></h3><h2>Developer documentation</h2><h3>Developing with the Ocsigen framework</h3><h4><a href="lwtoc" class="ocsimore_phrasing_link">Cooperative threads</a></h4><h4><a href="staticlink" class="ocsimore_phrasing_link">Static linking of the Ocsigen server</a></h4><h3><a href="extend" class="ocsimore_phrasing_link">Writing an extension</a></h3><h3><a href="libraries" class="ocsimore_phrasing_link">Libraries</a></h3><h1>Ocsigen server - API reference</h1><h2>Persistent data, writing in the logs, configuration file extension, polymorphic tables</h2><h3><a href=".././api/Ocsigen_lib" class="ocsimore_phrasing_link">Ocsigen_lib</a></h3><h3><a href=".././api/Ocsigen_messages" class="ocsimore_phrasing_link">Ocsigen_messages</a></h3><h3><a href=".././api/Ocsigen_parseconfig" class="ocsimore_phrasing_link">Ocsigen_parseconfig</a></h3><h3><a href=".././api/Polytables" class="ocsimore_phrasing_link">Polytables</a></h3><h3><a href=".././api/Ocsigen_cache" class="ocsimore_phrasing_link">Ocsigen_cache</a></h3><h3><a href=".././api/Ocsipersist" class="ocsimore_phrasing_link">Ocsipersist</a></h3><h3><a href=".././api/Ocsigen_config" class="ocsimore_phrasing_link">Ocsigen_config</a></h3><h2>Extending Ocsigen Server</h2><h3><a href=".././api/Ocsigen_extensions" class="ocsimore_phrasing_link">Ocsigen_extensions</a></h3><h3><a href=".././api/Ocsigen_local_files" class="ocsimore_phrasing_link">Ocsigen_local_files</a></h3><h3><a href=".././api/Ocsigen_headers" class="ocsimore_phrasing_link">Ocsigen_headers</a></h3><h3><a href=".././api/Ocsigen_senders" class="ocsimore_phrasing_link">Ocsigen_senders</a></h3><h3><a href=".././api/Ocsigen_http_frame" class="ocsimore_phrasing_link">Ocsigen_http_frame</a></h3><h3><a href=".././api/Ocsigen_http_client" class="ocsimore_phrasing_link">Ocsigen_http_client</a></h3><h3><a href=".././api/Ocsigen_http_com" class="ocsimore_phrasing_link">Ocsigen_http_com</a></h3><h3><a href=".././api/Ocsigen_stream" class="ocsimore_phrasing_link">Ocsigen_stream</a></h3><h3><a href=".././api/Ocsigen_comet" class="ocsimore_phrasing_link">Ocsigen_comet</a></h3><h3><a href=".././api/Authbasic" class="ocsimore_phrasing_link">Authbasic</a></h3><h2>Indexes</h2><h3> <span><a href=".././api/index_types">Index of types</a></span></h3><h3> <span><a href=".././api/index_exceptions">Index of exceptions</a></span></h3><h3> <span><a href=".././api/index_values">Index of values</a></span></h3><h3> <span><a href=".././api/index_methods">Index of class methods</a></span></h3><h3> <span><a href=".././api/index_classes">Index of classes</a></span></h3><h3> <span><a href=".././api/index_modules">Index of modules</a></span></h3><h3> <span><a href=".././api/index_module_types">Index of module types</a></span></h3></nav></nav></aside></div><p class="reasonwarning">Warning: Reason support is experimental.
We are looking for beta-tester and contributors.
</p><button id="reason">Switch to </button><div class="twocols"><nav class="leftcol">Version <select class="how-versions" onchange="location = this.value;"><option value=".././../dev/manual/extend">dev</option><option value=".././../2.9/manual/extend" selected="selected">2.9</option><option value=".././../2.8/manual/extend">2.8</option><option value=".././../2.7/manual/extend">2.7</option><option value=".././../2.6/manual/extend">2.6</option><option value=".././../2.5/manual/extend">2.5</option><option value=".././../2.3/manual/extend">2.3</option><option value=".././../2.2/manual/extend">2.2</option><option value=".././../2.1/manual/extend">2.1</option><option value=".././../1.3.4/manual/extend">1.3.4</option><option value=".././../1.2.2/manual/extend">1.2.2</option><option value=".././../1.1.0/manual/extend">1.1.0</option></select><nav class="how-doctree"><h1>Ocsigen server</h1><h2>Usage</h2><h3><a href="quickstart" class="ocsimore_phrasing_link">Quick start</a></h3><h3><a href="launching" class="ocsimore_phrasing_link">Launching the server</a></h3><h3><a href="config" class="ocsimore_phrasing_link">Configuration file</a></h3><h3><a href="misc" class="ocsimore_phrasing_link">Misc</a></h3><h2>Extensions</h2><h3><a href="staticmod" class="ocsimore_phrasing_link">Staticmod</a></h3><h3><a href="eliom" class="ocsimore_phrasing_link">Eliom</a></h3><h3><a href="extendconfiguration" class="ocsimore_phrasing_link">Extendconfiguration</a></h3><h3><a href="accesscontrol" class="ocsimore_phrasing_link">Accesscontrol</a></h3><h3><a href="authbasic" class="ocsimore_phrasing_link">Authbasic</a></h3><h3><a href="cgimod" class="ocsimore_phrasing_link">CGImod</a></h3><h3><a href="deflatemod" class="ocsimore_phrasing_link">Deflatemod</a></h3><h3><a href="redirectmod" class="ocsimore_phrasing_link">Redirectmod</a></h3><h3><a href="revproxy" class="ocsimore_phrasing_link">Revproxy</a></h3><h3><a href="rewritemod" class="ocsimore_phrasing_link">Rewritemod</a></h3><h3><a href="outputfilter" class="ocsimore_phrasing_link">Outputfilter</a></h3><h3><a href="userconf" class="ocsimore_phrasing_link">Userconf</a></h3><h3><a href="comet" class="ocsimore_phrasing_link">Comet</a></h3><h3><a href="cors" class="ocsimore_phrasing_link">CORS</a></h3><h2>Developer documentation</h2><h3>Developing with the Ocsigen framework</h3><h4><a href="lwtoc" class="ocsimore_phrasing_link">Cooperative threads</a></h4><h4><a href="staticlink" class="ocsimore_phrasing_link">Static linking of the Ocsigen server</a></h4><h3><a href="extend" class="ocsimore_phrasing_link">Writing an extension</a></h3><h3><a href="libraries" class="ocsimore_phrasing_link">Libraries</a></h3><h1>Ocsigen server - API reference</h1><h2>Persistent data, writing in the logs, configuration file extension, polymorphic tables</h2><h3><a href=".././api/Ocsigen_lib" class="ocsimore_phrasing_link">Ocsigen_lib</a></h3><h3><a href=".././api/Ocsigen_messages" class="ocsimore_phrasing_link">Ocsigen_messages</a></h3><h3><a href=".././api/Ocsigen_parseconfig" class="ocsimore_phrasing_link">Ocsigen_parseconfig</a></h3><h3><a href=".././api/Polytables" class="ocsimore_phrasing_link">Polytables</a></h3><h3><a href=".././api/Ocsigen_cache" class="ocsimore_phrasing_link">Ocsigen_cache</a></h3><h3><a href=".././api/Ocsipersist" class="ocsimore_phrasing_link">Ocsipersist</a></h3><h3><a href=".././api/Ocsigen_config" class="ocsimore_phrasing_link">Ocsigen_config</a></h3><h2>Extending Ocsigen Server</h2><h3><a href=".././api/Ocsigen_extensions" class="ocsimore_phrasing_link">Ocsigen_extensions</a></h3><h3><a href=".././api/Ocsigen_local_files" class="ocsimore_phrasing_link">Ocsigen_local_files</a></h3><h3><a href=".././api/Ocsigen_headers" class="ocsimore_phrasing_link">Ocsigen_headers</a></h3><h3><a href=".././api/Ocsigen_senders" class="ocsimore_phrasing_link">Ocsigen_senders</a></h3><h3><a href=".././api/Ocsigen_http_frame" class="ocsimore_phrasing_link">Ocsigen_http_frame</a></h3><h3><a href=".././api/Ocsigen_http_client" class="ocsimore_phrasing_link">Ocsigen_http_client</a></h3><h3><a href=".././api/Ocsigen_http_com" class="ocsimore_phrasing_link">Ocsigen_http_com</a></h3><h3><a href=".././api/Ocsigen_stream" class="ocsimore_phrasing_link">Ocsigen_stream</a></h3><h3><a href=".././api/Ocsigen_comet" class="ocsimore_phrasing_link">Ocsigen_comet</a></h3><h3><a href=".././api/Authbasic" class="ocsimore_phrasing_link">Authbasic</a></h3><h2>Indexes</h2><h3> <span><a href=".././api/index_types">Index of types</a></span></h3><h3> <span><a href=".././api/index_exceptions">Index of exceptions</a></span></h3><h3> <span><a href=".././api/index_values">Index of values</a></span></h3><h3> <span><a href=".././api/index_methods">Index of class methods</a></span></h3><h3> <span><a href=".././api/index_classes">Index of classes</a></span></h3><h3> <span><a href=".././api/index_modules">Index of modules</a></span></h3><h3> <span><a href=".././api/index_module_types">Index of module types</a></span></h3></nav></nav><article class="rightcol"><h1>Writing an extension for Ocsigen server</h1><div class="wip"><p>Warning: This page is not up to date.</p></div><p>This page describes how to extend Ocsigen's server. This can be used to create new ways to generate pages (like Apache modules), to filter and change the requests (for example, rewriting of URLS), to extend the syntax of the configuration file.
</p><p>Remember to program your extensions in cooperative way using Lwt! 
</p><p>These features have been introduced in Ocsigen 0.6.0. The extension mechanism will be improved in the future to fit better the needs of developers. As very extensions have been written for now, all this is somewhat experimental, and we look forward to feedback from developers about missing features or problems. 
</p><p><em>Ocsigen is a collaborative project. Contributions are welcome. For example a proxy, a fastCGI module ...</em>
</p><h3>Filtering the requests or writing a module to generate pages </h3><p>You can take as example the files <span class="teletype">extensiontemplate.ml</span> or <span class="teletype">staticmod.ml</span> from Ocsigen's distribution. 
</p><p>The type of request is <span class="teletype">Extensions.request_info</span> (have a look at it in the interface of the module <span class="teletype">Extensions</span>). 
</p><p>Each extensions loaded in the configuration file tries to handle the request and returns something of type <span class="teletype">Extensions.answer</span>. If the page is not found by the extension (<span class="teletype">Ext_not_found</span>), the following one will try to handle the request. If the page is found, the answer is <span class="teletype">Ext_found r</span> where <span class="teletype">r</span> has type <span class="teletype">Extensions.result</span>. An extension can also modify the request before giving it to the next one (answer <span class="teletype">Ext_continue_with of Extensions.request_info</span>). 
</p><p>To write such an extension, just write a cmo or cma, and use the function Extensions.register_extension to register you extension. This function takes four functions as parameters: 
</p><ul><li> a function that will be called for each virtual server, generating two functions: 
<ul><li>one that will be called to generate the pages (it has type <span class="teletype">string option -&gt; request_info -&gt; answer Lwt.t</span>), where the <span class="teletype">string option</span> is the encoding for characters possibly specified in the configuration file, 
</li><li>one to parse the configuration file (see next section). 
</li></ul></li><li>a function that will be called at the beginning of the initialisation phase (if you need to initialize your extension, otherwise, put the identity). 
</li><li>a function that will be called at the end of the initialisation phase of the server (if you need to do something here, otherwise the identity function). 
</li><li>a function that will create an error message from the exceptions that may be raised during the initialisation phase, and raise again all other exceptions. That function has type <span class="teletype">exn -&gt; string</span>. Use the raise function if you don't need any. 
</li></ul><p>Example (from <span class="teletype">staticmod.ml</span>): 
</p><pre>let _ = register_extension
    ((fun _ -&gt; 
      let page_tree = 
        try 
          find hostpattern
        with Not_found -&gt;
          let n = new_pages_tree () in
          add hostpattern n;
          n
      in
      (gen page_tree, 
       parse_config page_tree)),
     start_init,
     end_init,
     raise)
</pre><p>While writing extensions, be very careful about site reloading. The initialisation phase will start again at each reloading, and the function you register will be called for each virtual at each reloading. 
</p><h3>Filtering the outputs </h3><p>It is also possible to create extensions that will filter the output of the server (for example to compress it). It is very similar to the previous one. Basically, use <span class="teletype">Extensions.register_output_filter</span> instead of <span class="teletype">Extensions.register_extension</span>. Have a look at the file <span class="teletype">deflatemod.ml</span> for an example.
</p><h3>Extending the configuration file </h3><h4>Extending the configuration file for an extension </h4><p>The parsing of Ocsigen's configuration file is using a very basic xml parser (module <span class="teletype">Simplexmlparser</span>). The function to be registered by the <span class="teletype">Extensions.register_extension</span> function takes two parameters: the path of the web site and the xml subtree. 
</p><pre>let parse_config path = function
    Simplexmlparser.Element (&quot;tag&quot;, attr, content) -&gt; ...
      (* Do what you want here *)
  | Simplexmlparser.Element _ -&gt; 
      raise (Extensions.Bad_config_tag_for_extension t)
  | _ -&gt; raise (Extensions.Error_in_config_file &quot;(my extension)&quot;)
</pre><p>The module <span class="teletype">Parseconfig</span> defines functions to parse strings or sizes (in bytes, GB etc). 
</p><h4>Giving parameters to an extension </h4><p><em>Warning: This is experimental. Please report your experience if you use it.</em>
</p><p>Extensions may take parameters in the configuration file. During the loading of the extension, the function <span class="teletype">Extensions.get_config ()</span> returns the xml tree between <span class="teletype">&lt;extension&gt;</span> and <span class="teletype">&lt;/extension&gt;</span> (or <span class="teletype">&lt;library&gt;</span> and <span class="teletype">&lt;/library&gt;</span>). Write a parser for that tree. 
</p><h3>Catching the request before it is fully read </h3><p>For some extensions of the Web server, it is necessary to catch the request before it has been fully read (especially before the body of the request has been read). For example it is the case if you want to write a (reverse) proxy. 
</p><p><em>Warning: This is experimental. Please report your experience if you use it.</em>
</p><h3>Observing the headers to be sent by the server</h3><p><em>Warning: This is experimental. Please report your experience if you use it.</em>
</p><p>If you want, for example, to log the headers of outgoing HTTP frames, use the function
<span class="teletype">Ocsigen_http_com.set_result_observer</span>.
It takes as parameter a function of type
<span class="teletype">(Ocsigen_http_frame.Http_header.http_header -&gt; string -&gt; unit Lwt.t)</span>, the <span class="teletype">string</span> being the set of headers already pretty-printed.
</p><h3>Adding new commands for the server</h3><p>If you want to add your own commands for the server command pipe, do something like:
</p><pre>let () = 
  Ocsigen_extensions.register_command_function ~prefix:&quot;yourextensionname&quot;
    (fun s c -&gt; match c with
       | [&quot;mycommand&quot;] -&gt; ...
       | _ -&gt; raise Ocsigen_extensions.Unknown_command)
</pre></article></div></div></body></html>
