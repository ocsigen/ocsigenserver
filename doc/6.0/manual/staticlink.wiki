=Using Ocsigen Server as a library=

==Creating and running a statically linked executable==

Instead of using a configuration file, you can use Ocsigen Server as a library
for your OCaml program.

Call function <<a_api |val Ocsigen_server.start>> like this to run the server:
<<code language="ocaml"|
let _ =
  Ocsigen_server.start
    [ Ocsigen_server.host [Staticmod.run ~dir:"local/var/www/mysite/" ()]]
>>

Have a look at the API documentation for <<a_api |val Ocsigen_server.start>>
to see how to provide configuration options.

As with the configuration file, you can define several virtual hosts,
for example for different hostnames. See function 
<<a_api |val Ocsigen_server.host>> to configure them.

Functions like <<a_api |val Staticmod.run>> are defined by extensions.

Each request received by the server goes through all the instructions given
in the list. These instructions can be:
- either input filters that will modify the request
 (for example [[rewritemod|Rewritemod]])
- or page generation instructions (for example with [[staticmod|Staticmod]],
 [[eliom|Eliom]] or [[redirectmod|Redirectmod]])
- or output filters, that will modify the result (for example
[[deflatemod|Deflatemod]] or [[cors|CORS]]).

Here is an example of a more complex configuration:
<<code language="ocaml"|
let _ =
  Ocsigen_server.start ~debugmode:true ~veryverbose:()
    [ Ocsigen_server.host ~re:"foo.com" [Staticmod.run ~dir:"static" ()]
    ; Ocsigen_server.host ~re:".*"
        [ Redirectmod.run
            ~redirection:
              (Redirectmod.create_redirection ~full_url:`No ~regexp:"^p.*$"
                 "toto.html")
            ()
        ; Authbasic.run ~realm:"pouette"
            ~auth:(fun _u p -> Lwt.return (p = "mypassword"))
            ()
        ; Staticmod.run ~dir:"static" ()
        ; Eliom.run ()
        ; Cors.run ~credentials:false ()
        ; Deflatemod.run ~mode:(`All_but []) () ] ]>>

==Experimental: Using a configuration file with a static executable==
If you want to use the configuration file with a statically linked executable,
call
{{{
Ocsigen_server.exec (Ocsigen_parseconfig.parse_config ())
}}}
to launch the server's main loop.

Alternatively, you can link module {{{ocsigenserver.cmx}}}
to set the default commandline option and launch the main loop.

If you still want to use dynamic linking, add option {{{-linkall}}} while
compiling, otherwise the compiler may remove some modules from packages
{{{cma/cmxa}}}.

All statically linked extensions need to be initialized from the configuration 
file. To do that, replace the lines like:
{{{
<extension module="staticmod.cmxs" />
}}}
or
{{{
<extension findlib-package="ocsigenserver.ext.staticmod" />
}}}
by
{{{
<extension name="staticmod" />
}}}
This will not load a new module, but merely initializes one which must have been
linked statically. Thus it is possible to give configuration options to
extensions as usual.

This is an experimental feature.
Let us know if you test it (for example by opening an issue on Github).